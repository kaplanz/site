---
import Meta from "../../components/meta.astro";
import Page from "../../layouts/page.astro";

import { getCollection } from "astro:content";
import { markdown } from "@astropub/md";

import * as cheerio from "cheerio";

const frontmatter = {
  title: "Blog",
  about: `
    My thoughts on whatever I find interesting at the moment. Warranty not included.
  `.trim(),
};

// Collect sorted posts
const posts = (await getCollection("blog"))
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.created.valueOf() - a.data.created.valueOf());

// Compute post summaries
for (const post of posts) {
  // Render body to markdown
  const body = await markdown(post.body);
  // Parse document from HTML
  const $ = cheerio.load(body.toString(), null, false);
  // Extract first paragraph
  post.summary = $("p").first().text();
}
---

<Page {...frontmatter}>
  <p>{frontmatter.about}</p>
  <section class="blog">
    {posts.map(post => (
      <article class="post">
        <header>
          <h1>
            <a href=`/blog/${post.slug}`>
              <span class="title" id={post.slug}>{post.data.title}</span>
            </a>
          </h1>
          <Meta {...post.data}/>
        </header>
        <section>
          <p>
            {post.data.description || post.summary}
          </p>
        </section>
      </article>
    ))}
  </section>
</Page>

<style>
  section.blog {
    display: flex;
    flex-direction: column;
    gap: 1em;

    margin: 0;
    padding: 0;

    article.post {
      list-style: none;

      border: 2px solid var(--darker);
      border-radius: 8px;
      box-shadow: 2.25px 3px var(--shadow);

      background: var(--darken);
      padding-inline: 1em;
      box-sizing: content-box;

      h1 {
        font-size: 1.6em;
      }

      a:not(:hover) {
        text-decoration-color: transparent;
      }

      .title {
        font: inherit;
      }
    }
  }
</style>
